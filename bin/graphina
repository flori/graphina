#!/usr/bin/env ruby

require 'graphina'
require 'term/ansicolor'
include Tins::GO
require 'shellwords'

def usage
  puts <<~EOT
  Usage: #{File.basename($0)} [OPTIONS]

    OPTIONS are

      -t TITLE      Title for the graph (default: 'Data')
      -n SECONDS    Update interval in seconds (default: 5)
      -r MODE       Resolution mode (:single or :double, default: :double)
      -f COLOR      Foreground color (default: :white)
      -b COLOR      Background color (default: :black)
      -c COLOR      Primary color (default: derived from title)
      -C COLOR      Secondary color (default: derived from primary)
      -F FORMAT     Format function (:as_bytes, :as_hertz, :as_celsius, :as_percent, :as_default, default: :as_default)
      -P PANEL      Use predefined panel configuration (default: interactive selection)
      -S CONFIG     Setup panel config (default infers from OS)
      -e COMMAND    External command to execute for data values (default: random data)
      -h            this help

    Examples:

      graphina                              # Basic usage with random data
      graphina -t "CPU Usage"               # Custom title
      graphina -t "Memory" -f blue -b black # Custom colors
      graphina -t "Network" -r single -n 2  # Single resolution, 2 second updates
      # Full examples
      graphina -t 'CPU Usage (%)' -n 1 -F as_percent -e "top -l 1 -n 0 | awk '/^CPU usage:/ { print \\$3 + \\$5 }'"
      graphina -t 'Memory' -n 1 -F as_bytes -e "free -b | awk '/^Mem:/ { print \\$4 }'"

  EOT
  0
end

$opts = go 't:n:r:f:b:c:C:F:e:P:S:h'

$opts[?h] and exit usage
if $opts[?S]
  setup = Graphina::Setup.new(default_panels_name: $opts[?S])
  setup.install_default_panels
  exit
end

panel = Graphina::Panel.new
case
when panel_name = $opts[?P]
  if panel_config = Graphina::GraphinaConfig::PANELS[panel_name]
    panel.configure(panel_config)
  else
    STDERR.puts "No panel named #{panel_name.inspect} defined!"
    exit 1
  end
when $opts[?e]
  panel.configure_from_opts($opts)
when panels = Graphina::GraphinaConfig::PANELS
  unless panel = Graphina::Panel::Chooser.choose(panels) 
    STDERR.puts "No panel chosen."
    exit 0
  end
else
  panel.configure_from_opts($opts)
end
graph = Graphina::Graph.new(
  title:            panel.title,
  sleep:            panel.interval,
  value:            panel.value,
  true_coloring:    ENV['COLORTERM'] =~ /\A(truecolor|24bit)\z/,
  color:            panel.color,
  color_secondary:  panel.color_secondary,
  foreground_color: panel.foreground_color,
  background_color: panel.background_color,
  resolution:       panel.resolution,
  format_value:     panel.format_value,
)
graph.start
